<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>এডমিন ড্যাশবোর্ড - eFoodDokan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+Bengali:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        /* কাস্টম ফন্ট এবং ব্যাকগ্রাউন্ড স্টাইল */
        body {
            font-family: 'Noto Sans Bengali', 'Inter', sans-serif;
            background-color: #f0fdf4;
            color: #1f2937;
        }

        /* কাস্টম অ্যানিমেশন */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0.6); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* কাস্টম Scrollbar স্টাইল */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 10px; border: 2px solid #e2e8f0; }

        /* বোতামের স্টাইল */
        .btn-action {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="min-h-screen flex flex-col justify-center items-center p-4">
        <!-- Dashboard Header -->
        <header class="w-full max-w-7xl mx-auto flex justify-between items-center bg-white p-4 md:p-6 rounded-t-3xl shadow-lg border-b-4 border-green-500">
            <h1 class="text-2xl md:text-4xl font-extrabold text-green-700 flex items-center space-x-2">
                <i class="fas fa-chart-line"></i>
                <span>এডমিন ড্যাশবোর্ড</span>
            </h1>
            <div id="authUI">
                <!-- Auth UI এখানে লোড হবে -->
            </div>
        </header>

        <!-- Main Content -->
        <main class="w-full max-w-7xl mx-auto bg-white p-4 md:p-8 rounded-b-3xl shadow-lg flex-grow">
            <!-- Access Denied Message -->
            <div id="accessDeniedMsg" class="hidden text-center py-20 animate-[fadeIn_1s_ease-out]">
                <i class="fas fa-user-shield text-6xl text-red-500 mb-6 animate-pulse"></i>
                <h2 class="text-3xl font-bold mb-4">অ্যাডমিন অ্যাক্সেস নেই</h2>
                <p class="text-lg text-gray-600">আপনি এই ড্যাশবোর্ডটি দেখার জন্য অনুমোদিত নন।</p>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent" class="hidden animate-[fadeIn_1s_ease-out]">
                <h2 class="text-3xl font-extrabold text-center text-green-600 mb-8">স্বাগতম, অ্যাডমিন!</h2>

                <!-- Sections Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">

                    <!-- Pending Orders Section -->
                    <div class="bg-amber-50 p-6 rounded-2xl shadow-md border-t-4 border-amber-500 card-hover-effect">
                        <h3 class="text-xl font-bold mb-4 text-amber-700">
                            <i class="fas fa-hourglass-half mr-2"></i>প্রক্রিয়াধীন অর্ডার
                        </h3>
                        <div id="pendingOrdersContainer" class="space-y-4 max-h-80 overflow-y-auto custom-scrollbar">
                            <!-- Pending orders will be loaded here -->
                        </div>
                    </div>

                    <!-- Coupons Section -->
                    <div class="bg-blue-50 p-6 rounded-2xl shadow-md border-t-4 border-blue-500 card-hover-effect">
                        <h3 class="text-xl font-bold mb-4 text-blue-700">
                            <i class="fas fa-tags mr-2"></i>কুপন ম্যানেজমেন্ট
                        </h3>
                        <form id="couponForm" class="space-y-4 mb-6">
                            <input type="text" id="couponCode" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="কুপন কোড (যেমন: EID200)" required>
                            <input type="number" id="couponDiscount" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ডিসকাউন্ট পরিমাণ (৳)" required>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-bold btn-action">
                                <i class="fas fa-plus-circle mr-2"></i> নতুন কুপন অ্যাড করুন
                            </button>
                        </form>
                        <div id="couponsContainer" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                            <!-- Coupons will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[1001] hidden">
        <div class="modal-content w-11/12 max-w-sm bg-white rounded-2xl shadow-2xl relative p-8 text-center">
            <h3 id="alertTitle" class="text-2xl font-bold mb-4"></h3>
            <p id="alertMessage" class="text-lg text-gray-700 mb-6"></p>
            <button id="alertOkButton" class="bg-green-500 text-white py-2 px-6 rounded-full font-bold hover:bg-green-600 transition-colors">ঠিক আছে</button>
        </div>
    </div>

    <script type="module">
        // Firebase SDKs আমদানি করা হচ্ছে
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, onSnapshot, serverTimestamp, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // আপনার নতুন Firebase কনফিগারেশন
        const firebaseConfig = {
          apiKey: "AIzaSyBgsTWPPGzriNt8GfIT7FXeoMwLyh3ikmA",
          authDomain: "jhal-muri-45900.firebaseapp.com",
          projectId: "jhal-muri-45900",
          storageBucket: "jhal-muri-45900.firebasestorage.app",
          messagingSenderId: "552863012715",
          appId: "1:552863012715:web:6429d774595b235cdc9e2e",
          measurementId: "G-8T8VDW81PB"
        };
        
        // Firebase ইনিশিয়ালাইজ করা
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // অ্যাডমিন ইমেল
        const ADMIN_EMAIL = "hossainrahad632@gmail.com";

        // UI উপাদানগুলো নির্বাচন করা
        const authUI = document.getElementById('authUI');
        const dashboardContent = document.getElementById('dashboardContent');
        const accessDeniedMsg = document.getElementById('accessDeniedMsg');
        const pendingOrdersContainer = document.getElementById('pendingOrdersContainer');
        const couponForm = document.getElementById('couponForm');
        const couponCodeInput = document.getElementById('couponCode');
        const couponDiscountInput = document.getElementById('couponDiscount');
        const couponsContainer = document.getElementById('couponsContainer');
        const customAlertModal = document.getElementById('customAlertModal');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        const alertOkButton = document.getElementById('alertOkButton');

        // কাস্টম alert() এর বিকল্প
        function showAlert(title, message, isSuccess = true) {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            if (isSuccess) {
                alertTitle.classList.add('text-green-600');
                alertTitle.classList.remove('text-red-600');
                alertOkButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                alertOkButton.classList.add('bg-green-500', 'hover:bg-green-600');
            } else {
                alertTitle.classList.add('text-red-600');
                alertTitle.classList.remove('text-green-600');
                alertOkButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                alertOkButton.classList.add('bg-red-500', 'hover:bg-red-600');
            }
            customAlertModal.classList.remove('hidden');
        }

        // Google লগইন ফাংশন
        async function signInWithGoogle() {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google লগইন ব্যর্থ হয়েছে: ", error);
            }
        }

        // Google লগআউট ফাংশন
        async function handleSignOut() {
            try {
                await signOut(auth);
                console.log("সফলভাবে লগআউট হয়েছে");
            } catch (error) {
                console.error("লগআউট ব্যর্থ হয়েছে:", error);
            }
        }

        // Pending Orders লোড করার ফাংশন
        function loadPendingOrders() {
            pendingOrdersContainer.innerHTML = '';
            const q = query(collection(db, "orders"), where("status", "==", "Pending"));
            onSnapshot(q, (querySnapshot) => {
                pendingOrdersContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    pendingOrdersContainer.innerHTML = `<p class="text-center text-gray-500">কোনো নতুন অর্ডার নেই।</p>`;
                } else {
                    querySnapshot.forEach((docSnapshot) => {
                        const order = docSnapshot.data();
                        const orderId = docSnapshot.id;
                        const orderDate = new Date(order.timestamp.seconds * 1000);

                        const orderCard = document.createElement('div');
                        orderCard.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-200';
                        orderCard.innerHTML = `
                            <p class="font-bold">আইডি: ${order.id}</p>
                            <p class="text-sm text-gray-600">নাম: ${order.userName}</p>
                            <p class="text-sm text-gray-600">ফোন: ${order.userPhone}</p>
                            <p class="text-sm text-gray-600">তারিখ: ${orderDate.toLocaleDateString('bn-BD')}</p>
                            <p class="text-sm font-bold mt-2">মোট মূল্য: ৳ ${order.totalPrice.toLocaleString('bn-BD')}</p>
                            <div class="flex space-x-2 mt-4">
                                <button data-id="${orderId}" class="approve-btn bg-green-500 text-white text-xs px-3 py-1 rounded-full btn-action">
                                    অ্যাপ্রুভ
                                </button>
                                <button data-id="${orderId}" class="cancel-btn bg-red-500 text-white text-xs px-3 py-1 rounded-full btn-action">
                                    বাতিল
                                </button>
                            </div>
                        `;
                        pendingOrdersContainer.appendChild(orderCard);
                    });

                    // ইভেন্ট লিসেনার সেট করা
                    document.querySelectorAll('.approve-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const id = e.target.dataset.id;
                            try {
                                await updateDoc(doc(db, "orders", id), { status: 'Approved' });
                                showAlert('সফল!', 'অর্ডারটি অ্যাপ্রুভ করা হয়েছে।', true);
                            } catch (error) {
                                console.error("Error approving order:", error);
                                showAlert('ব্যর্থ', 'অর্ডার অ্যাপ্রুভ করতে সমস্যা হয়েছে।', false);
                            }
                        });
                    });

                    document.querySelectorAll('.cancel-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const id = e.target.dataset.id;
                            try {
                                await updateDoc(doc(db, "orders", id), { status: 'Cancelled' });
                                showAlert('সফল!', 'অর্ডারটি বাতিল করা হয়েছে।', true);
                            } catch (error) {
                                console.error("Error cancelling order:", error);
                                showAlert('ব্যর্থ', 'অর্ডার বাতিল করতে সমস্যা হয়েছে।', false);
                            }
                        });
                    });
                }
            });
        }

        // Coupons লোড করার ফাংশন
        function loadCoupons() {
            couponsContainer.innerHTML = '';
            const q = query(collection(db, "coupons"));
            onSnapshot(q, (querySnapshot) => {
                couponsContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    couponsContainer.innerHTML = `<p class="text-center text-gray-500 text-sm">কোনো কুপন নেই।</p>`;
                } else {
                    querySnapshot.forEach((docSnapshot) => {
                        const coupon = docSnapshot.data();
                        const couponId = docSnapshot.id;

                        const couponCard = document.createElement('div');
                        couponCard.className = 'flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-gray-200';
                        couponCard.innerHTML = `
                            <div>
                                <p class="font-bold text-sm">${coupon.code}</p>
                                <p class="text-xs text-gray-600">৳ ${coupon.discount} ডিসকাউন্ট</p>
                            </div>
                            <button data-id="${couponId}" class="delete-coupon-btn text-red-500 hover:text-red-700 transition-colors">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        `;
                        couponsContainer.appendChild(couponCard);
                    });

                    // ইভেন্ট লিসেনার সেট করা
                    document.querySelectorAll('.delete-coupon-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const id = e.target.closest('button').dataset.id;
                            try {
                                await deleteDoc(doc(db, "coupons", id));
                                showAlert('সফল!', 'কুপনটি মুছে ফেলা হয়েছে।', true);
                            } catch (error) {
                                console.error("Error deleting coupon:", error);
                                showAlert('ব্যর্থ', 'কুপন মুছে ফেলতে সমস্যা হয়েছে।', false);
                            }
                        });
                    });
                }
            });
        }
        
        // কুপন ফর্ম সাবমিট করার ফাংশন
        async function handleCouponSubmit(e) {
            e.preventDefault();
            const code = couponCodeInput.value.trim().toUpperCase();
            const discount = parseInt(couponDiscountInput.value);

            if (!code || isNaN(discount) || discount <= 0) {
                showAlert('ত্রুটি', 'দয়া করে সঠিক কুপন কোড এবং ডিসকাউন্ট পরিমাণ দিন।', false);
                return;
            }

            try {
                // Check if coupon code already exists
                const q = query(collection(db, "coupons"), where("code", "==", code));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    showAlert('ব্যর্থ', 'এই কুপন কোডটি ইতিমধ্যেই আছে।', false);
                    return;
                }

                await addDoc(collection(db, "coupons"), {
                    code: code,
                    discount: discount,
                    createdAt: serverTimestamp()
                });
                couponForm.reset();
                showAlert('সফল!', 'নতুন কুপন সফলভাবে যোগ করা হয়েছে।', true);
            } catch (error) {
                console.error("Error adding coupon:", error);
                showAlert('ব্যর্থ', 'কুপন যোগ করতে সমস্যা হয়েছে।', false);
            }
        }
        
        //AuthState পরিবর্তন হলে এই ফাংশনটি কল হবে
        function setupAuthAndListeners() {
            onAuthStateChanged(auth, (user) => {
                if (user && user.email === ADMIN_EMAIL) {
                    // Admin logged in
                    authUI.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <span class="font-bold text-gray-700 hidden md:inline">স্বাগতম, অ্যাডমিন!</span>
                            <button id="signOutButton" class="bg-red-500 text-white py-2 px-4 rounded-full font-bold flex items-center space-x-2 shadow-lg hover:bg-red-600 transition-colors">
                                <i class="fas fa-sign-out-alt mr-2"></i> লগআউট
                            </button>
                        </div>
                    `;
                    document.getElementById('signOutButton').addEventListener('click', handleSignOut);
                    dashboardContent.classList.remove('hidden');
                    accessDeniedMsg.classList.add('hidden');
                    loadPendingOrders();
                    loadCoupons();
                } else {
                    // Not an admin or not logged in
                    authUI.innerHTML = `
                        <button id="googleSignInButton" class="bg-blue-500 text-white py-2 px-4 rounded-full font-bold flex items-center space-x-2 shadow-lg hover:bg-blue-600 transition-colors">
                            <i class="fab fa-google"></i>
                            <span>লগইন করুন</span>
                        </button>
                    `;
                    document.getElementById('googleSignInButton').addEventListener('click', signInWithGoogle);
                    dashboardContent.classList.add('hidden');
                    accessDeniedMsg.classList.remove('hidden');
                }
            });
        }
        
        // ইভেন্ট লিসেনার
        document.addEventListener('DOMContentLoaded', function() {
            setupAuthAndListeners();
            couponForm.addEventListener('submit', handleCouponSubmit);
            alertOkButton.addEventListener('click', () => customAlertModal.classList.add('hidden'));
        });
    </script>
</body>
</html>
